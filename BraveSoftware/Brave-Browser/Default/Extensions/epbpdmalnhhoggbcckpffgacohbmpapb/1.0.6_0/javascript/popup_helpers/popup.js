var DarkReader;!function(e){var t={remote:"../../assets/config_dark_sites.json",local:"../../assets/config_dark_sites.json"},n={remote:"../../assets/config_inversion.json",local:"../../assets/config_inversion.json"},o={local:"../../assets/config_filters.json"};e.DEBUG=!0;function i(t,n){Array.isArray(t)||(t=[],n&&n("Dark Sites list is not an array."));for(var o=t.length-1;o>=0;o--)"string"!=typeof t[o]&&t.splice(o,1);t.sort(e.urlTemplateSorter),e.DARK_SITES=t}function r(t,n){null!==t&&"object"==typeof t||(t={common:{},sites:[]},n&&n("Inversion Fix config is not an object.")),t.common||(t.common={}),t.common.invert=u(t.common.invert),t.common.noinvert=u(t.common.noinvert),t.common.removebg=u(t.common.removebg),t.common.rules=u(t.common.rules),Array.isArray(t.sites)||(t.sites=[]);for(var o=t.sites.length-1;o>=0;o--){var i=t.sites[o];"string"==typeof(r=i.url)||Array.isArray(r)?(i.invert=u(i.invert),i.noinvert=u(i.noinvert),i.removebg=u(i.removebg),i.rules=u(i.rules)):t.sites.splice(o,1)}var r;t.sites.forEach((function(e){e.invert=t.common.invert.concat(e.invert),e.noinvert=t.common.noinvert.concat(e.noinvert),e.removebg=t.common.removebg.concat(e.removebg),e.rules=t.common.rules.concat(e.rules)})),e.INVERSION_FIXES=t}function s(t,n){if(null!==t&&"object"==typeof t){for(var o in e.DEFAULT_FILTER_CONFIG)typeof t[o]!=typeof e.DEFAULT_FILTER_CONFIG[o]&&(n&&n('Invalid config property "'+o+'"'),t[o]=e.DEFAULT_FILTER_CONFIG[o]);e.DEFAULT_FILTER_CONFIG=t}}function a(e){return fetch(e.url+"?nocache="+(new Date).getTime()).then((e=>e.text())).then((e=>{const t=e.replace(/(\".*?(\\\".*?)*?\")|(\/\*(.|[\r\n])*?\*\/)|(\/\/.*?[\r\n])/gm,"$1");return JSON.parse(t)}))}function c(e,t){var n=function(e){var t,n,o,i="^"===(e=e.trim())[0],r="$"===e[e.length-1];e=e.replace(/^\^/,"").replace(/\$$/,"").replace(/^.*?\/{2,3}/,"").replace(/\?.*$/,"").replace(/\/$/,""),(t=e.indexOf("/"))>=0?(n=e.substring(0,t),o=e.replace("$","").substring(t)):n=e.replace("$","");var s=i?"^(.*?\\:\\/{2,3})?":"^(.*?\\:\\/{2,3})?([^/]*?\\.)?",a=n.split(".");s+="(";for(var c=0;c<a.length;c++)"*"===a[c]&&(a[c]="[^\\.\\/]+?");s+=a.join("\\."),s+=")",o&&(s+="(",s+=o.replace("/","\\/"),s+=")");return s+=r?"(\\/?(\\?[^/]*?)?)$":"(\\/?.*?)$",new RegExp(s,"i")}(t);return!!e.match(n)}function u(e){return Array.isArray(e)?e:e?[e]:[]}function l(e){return JSON.parse(JSON.stringify(e))}e.DARK_SITES,e.INVERSION_FIXES,e.RAW_INVERSION_FIXES,e.loadConfigs=function(c){function u(t){if(e.DEBUG)throw new Error(t)}Promise.all([a({url:t.local}).then((function(e){return i(e,u)})),a({url:n.local}).then((function(t){e.RAW_INVERSION_FIXES=t,r(l(t),u)})),a({url:o.local}).then((function(e){return s(e,u)}))]).then((function(){return c&&c()}),(function(e){}))},e.handleInversionFixes=r,e.getFixesFor=function(t){var n;if(t)e:for(var o=0;o<e.INVERSION_FIXES.sites.length;o++)for(var i=e.INVERSION_FIXES.sites[o],r="string"==typeof i.url?[i.url]:i.url,s=0;s<r.length;s++)if(c(t,r[s])){n=i;break e}return n||{invert:e.INVERSION_FIXES.common.invert,noinvert:e.INVERSION_FIXES.common.noinvert,removebg:e.INVERSION_FIXES.common.removebg,rules:e.INVERSION_FIXES.common.rules}},e.isUrlInList=function(e,t){for(var n=0;n<t.length;n++)if(c(e,t[n]))return!0;return!1},e.urlTemplateSorter=function(e,t){"string"==typeof e&&(e={url:e}),"string"==typeof t&&(t={url:t});var n=e.url.indexOf("/"),o=t.url.indexOf("/"),i=e.url.replace("^","").substring(0,n),r=t.url.replace("^","").substring(0,o),s=i.split(".").reverse().join(".").toLowerCase(),a=r.split(".").reverse().join(".").toLowerCase();if(s>a)return-1;if(s<a)return 1;var c=e.url.substring(n),u=t.url.substring(o);return-c.localeCompare(u)},e.formatJson=function(e){return JSON.stringify(e,null,4)+"\n"},e.copyJson=l}(DarkReader),function(e){var t="DarkModeOn",n="DarkModeOff",o="NightModeOn",i="NightModeOff",r=function(r){function a(e,s){var a=this;r.call(this),this.darkModeListener=function(e,o){e.name===t&&(o.config.mode=1),e.name===n&&(o.config.mode=0)},this.nightModeListener=function(e,t){e.name===o&&(t.config.nightMode=1),e.name===i&&(t.config.nightMode=0)},this.tabUpdateListener=function(e,t,n){a.addStyleToTab(n)},this.tabReplaceListener=function(e,t){},this.generator=e,xp.Model.property(this,"enabled",!1),xp.Model.property(this,"config",null),xp.Model.property(this,"configCopy",null),xp.Model.property(this,"popupOpenCount",0),xp.Model.property(this,"fonts",[]);var c=new xp.EventRegistrar;this.onPropertyChanged.addHandler((function(e){null===a.configCopy&&(a.configCopy=Object.assign({},a.config)),"enabled"===e&&a.onAppToggle(),"config"===e&&(c.unsubscribeAll(),c.subscribe(a.config.onPropertyChanged,a.onConfigPropChanged,a),c.subscribe(a.config.siteList.onCollectionChanged,a.onConfigPropChanged,a),c.subscribe(a.config.blackList.onCollectionChanged,a.onConfigPropChanged,a),c.subscribe(a.config.whiteList.onCollectionChanged,a.onConfigPropChanged,a),a.onConfigPropChanged()),"popupOpenCount"===e&&a.saveUserSettings()})),this.loadUserSettings().then((()=>s()));var u=this;this.getFontList((function(e){return a.fonts=e})),this.addAlarmListeners(),chrome.commands.onCommand.addListener((function(e){"toggle"===e&&(a.enabled=!a.enabled),"darkModeToggle"===e&&(u.config.mode=0===u.config.mode?1:0),"nightModeToggle"===e&&(u.config.nightMode=0===u.config.nightMode?1:0)}))}return __extends(a,r),a.prototype.incrementPopupOpenCount=function(e){-1!==this.popupOpenCount&&(this.popupOpenCount=-1===e?e:this.popupOpenCount+e)},a.prototype.addAlarmListeners=function(){var e=this;!0!==e.darkAlarmListenerOn&&(e.darkAlarmListenerOn=!0),!0!==e.nightAlarmListenerOn&&(e.nightAlarmListenerOn=!0)},a.prototype.removeAlarmListeners=function(e){e!==i&&e!==o||(this.nightAlarmListenerOn=!1),e!==n&&e!==t||(this.darkAlarmListenerOn=!1)},a.prototype.getActiveTabInfo=function(t){chrome.tabs.query({active:!0,currentWindow:!0},(function(n){if(1===n.length){var o=n[0].url,i=o.match(/^(.*?:\/{2,3})?(.+?)(\/|$)/)[2],r={url:o,host:i,isProtected:!s(o),isInDarkList:e.isUrlInList(o,e.DARK_SITES)};t(r)}else{if(e.DEBUG)throw new Error("Unexpected tabs count.");t({url:"",host:"",isProtected:!1,isInDarkList:!1})}}))},a.prototype.getTimeStamp=function(e){if(""!==e)return new Date("01/01/2019 "+e).getTime();var t=(new Date).getHours(),n=(new Date).getMinutes();return new Date("01/01/2019 "+(t<10?"0"+t:t)+":"+(n<10?"0"+n:n)).getTime()},a.prototype.isScheduleOn=function(e,t){if(""!==e&&""!==t){var n=this.getTimeStamp(e),o=this.getTimeStamp(t),i=this.getTimeStamp("");return n>o&&(o+=864e5),i>=n&&o>=i}},a.prototype.toggleModeBasedOnSchedule=function(e,t){var n=this.config;if("night"===e){var o=this.isScheduleOn(n.nightScheduleFrom,n.nightScheduleTo);t&&o&&1===n.nightMode?n.nightMode=0:!t&&o&&0===n.nightMode&&(n.nightMode=1)}if("dark"===e){o=this.isScheduleOn(n.modeScheduleFrom,n.modeScheduleTo);t&&o&&1===n.mode?n.mode=0:!t&&o&&0===n.mode&&(n.mode=1)}},a.prototype.toggleCurrentSite=function(e){var t=this;this.getActiveTabInfo((function(n){if(n.host){var o=t.config.blackList.indexOf(n.host);o<0?(null===e||null!==e&&e.element.elementOff.className.search("active")>-1)&&t.config.blackList.push(n.host):(null===e||null!==e&&e.element.elementOn.className.search("active")>-1)&&t.config.blackList.splice(o,1)}}))},a.prototype.onAppToggle=function(){},a.prototype.clearNightAlarms=function(){},a.prototype.clearDarkAlarms=function(){},a.prototype.createAlarms=function(){},a.prototype.onConfigPropChanged=function(){this.saveUserSettings((()=>{chrome.runtime.sendMessage({action:"run"},(()=>{}))}))},a.prototype.addTabListeners=function(){},a.prototype.removeTabListeners=function(){},a.prototype.canInjectScript=function(e){return e&&s(e.url)},a.prototype.addStyleToTab=function(e){},a.prototype.removeStyleFromTab=function(e){},a.prototype.getCode_addStyle=function(e){},a.prototype.getCode_removeStyle=function(){},a.prototype.loadUserSettings=function(){return new Promise((t=>{var n=this,o=xp.clone(e.DEFAULT_FILTER_CONFIG),i={enabled:!0,config:o,configCopy:o,installedTimestamp:0,popupOpenCount:0};chrome.storage.sync.get(i,(function(e){if(e.config||(e.config=o),e.configCopy||(e.configCopy=o),!Array.isArray(e.config.siteList)){var i=[];for(var r in e.config.siteList)i[r]=e.config.siteList[r];e.config.siteList=i}if(!Array.isArray(e.config.blackList)){i=[];for(var r in e.config.blackList)i[r]=e.config.blackList[r];e.config.blackList=i}if(!Array.isArray(e.config.whiteList)){i=[];for(var r in e.config.whiteList)i[r]=e.config.whiteList[r];e.config.whiteList=i}n.config=xp.observable(e.config),n.configCopy=Object.assign({},n.config),n.enabled=e.enabled,n.installedTimestamp=e.installedTimestamp,n.popupOpenCount=e.popupOpenCount,t()}))}))},a.prototype.saveUserSettings=function(e=(()=>{})){var t=this;this.savedTimeout&&clearTimeout(this.savedTimeout),this.savedTimeout=setTimeout((function(){var n={enabled:t.enabled,config:t.config,configCopy:t.config,popupOpenCount:t.popupOpenCount,installedTimestamp:t.installedTimestamp};chrome.storage.sync.set(n,(function(){t.savedTimeout=null,e()}))}),1e3)},a.prototype.resetToDefault=function(){var t=xp.clone(e.DEFAULT_FILTER_CONFIG);t.mode=this.config.mode,t.nightMode=this.config.nightMode,t.modeSchedule=this.config.modeSchedule,t.modeScheduleFrom=this.config.modeScheduleFrom,t.modeScheduleTo=this.config.modeScheduleTo,t.nightSchedule=this.config.nightSchedule,t.nightScheduleFrom=this.config.nightScheduleFrom,t.nightScheduleTo=this.config.nightScheduleTo,this.config=xp.observable(t),this.configCopy=t,this.saveUserSettings((()=>{chrome.runtime.sendMessage({action:"run"},(()=>{}))}))},a.prototype.getFontList=function(e){chrome.fontSettings?chrome.fontSettings.getFontList((function(t){var n=t.map((function(e){return e.fontId}));e(n)})):setTimeout((function(){return e(["serif","sans-serif","monospace","cursive","fantasy","system-ui"])}))},a.prototype.getSavedDevInversionFixes=function(){return localStorage.getItem("dev_inversion_fixes")||null},a.prototype.saveDevInversionFixes=function(e){localStorage.setItem("dev_inversion_fixes",e)},a.prototype.getDevInversionFixesText=function(){var t=this.getSavedDevInversionFixes();return e.formatJson(t?JSON.parse(t):e.copyJson(e.RAW_INVERSION_FIXES))},a.prototype.resetDevInversionFixes=function(){localStorage.removeItem("dev_inversion_fixes"),e.handleInversionFixes(e.copyJson(e.RAW_INVERSION_FIXES)),this.onConfigPropChanged()},a.prototype.applyDevInversionFixes=function(t,n){var o;try{o=JSON.parse(t);var i=e.formatJson(o);this.saveDevInversionFixes(i),e.handleInversionFixes(o),this.onConfigPropChanged(),n(null)}catch(e){n(e)}},a}(xp.Model);function s(e){return e&&0!==e.indexOf("chrome")&&0!==e.indexOf("https://chrome.google.com/webstore")&&0!==e.indexOf("about:")&&0!==e.indexOf("view-source:")&&0!==e.indexOf("https://addons.mozilla.org")}e.Extension=r}(DarkReader),function(e){!function(e){e[e.light=0]="light",e[e.dark=1]="dark"}(e.FilterMode||(e.FilterMode={}));var t=e.FilterMode;!function(e){e[e.off=0]="off",e[e.on=1]="on"}(e.NightMode||(e.NightMode={}));var n=e.NightMode;!function(e){e[e.off=0]="off",e[e.on=1]="on"}(e.ModeSchedule||(e.ModeSchedule={}));e.ModeSchedule;!function(e){e[e.off=0]="off",e[e.on=1]="on"}(e.NightSchedule||(e.NightSchedule={}));e.NightSchedule;!function(e){e[e.whiteList=0]="whiteList",e[e.blackList=1]="blackList"}(e.ActiveList||(e.ActiveList={}));var o=e.ActiveList;e.DEFAULT_FILTER_CONFIG={mode:e.FilterMode.dark,nightMode:e.NightMode.off,brightness:100,contrast:100,grayscale:0,sepia:0,warm:0,useFont:!1,fontFamily:"Segoe UI",textStroke:0,invertListed:!1,siteList:[],blackList:[],whiteList:[],activeSiteList:o.blackList,modeSchedule:0,modeScheduleFrom:"23:30",modeScheduleTo:"06:00",nightSchedule:0,nightScheduleFrom:"23:30",nightScheduleTo:"06:00"};var i=function(){function i(){var e=navigator.userAgent.toLowerCase().match(/chrom[e|ium]\/([^ ]+)/);e&&e[1]&&(e[1]<"45.0.2431.0"&&(this.filterAppliesToHtml=!0))}return i.prototype.createShader=function(t,o){var i=e.isUrlInList(o,e.DARK_SITES),r=e.isUrlInList(o,t.siteList);return t.nightMode===n.on&&(r&&t.invertListed||!i&&!t.invertListed&&!r)},i.prototype.getTimeStamp=function(e){if(""!==e)return new Date("01/01/2019 "+e).getTime();var t=(new Date).getHours(),n=(new Date).getMinutes();return new Date("01/01/2019 "+(t<10?"0"+t:t)+":"+(n<10?"0"+n:n)).getTime()},i.prototype.isScheduleOn=function(e,t,n){if(0===e||""===t||""===n)return!0;if(1===e&&""!==t&&""!==n){var o=this.getTimeStamp(t),i=this.getTimeStamp(n),r=this.getTimeStamp("");return o>i&&(i+=864e5),r>=o&&i>=r}},i.prototype.createCssCode=function(i,r){var s=e.isUrlInList(r,e.DARK_SITES),a=e.isUrlInList(r,i.siteList),c=e.isUrlInList(r,i.blackList),u=e.isUrlInList(r,i.whiteList),l=this.isScheduleOn(i.modeSchedule,i.modeScheduleFrom,i.modeScheduleTo),p=this.isScheduleOn(i.nightSchedule,i.nightScheduleFrom,i.nightScheduleTo),h=[];if(h.push("@media screen {"),p&&(i.activeSiteList===o.blackList&&!c||i.activeSiteList===o.whiteList&&u)&&i.nightMode===n.on&&(a&&i.invertListed||!s&&!i.invertListed&&!a)&&(h.push("#screen-shader.on{"),h.push("transition: opacity 0.1s ease 0s;"),h.push("z-index: 2147483647;"),h.push("margin: 0;"),h.push("border-radius: 0;"),h.push("padding: 0;"),h.push("background: #fac563;"),h.push("pointer-events: none;"),h.push("position: fixed;"),h.push("top: -10%;"),h.push("right: -10%;"),h.push("width: 120%;"),h.push("height: 120%;"),h.push("opacity: "+(.8*Number(i.warm)/100+.2)+";"),h.push("mix-blend-mode: multiply;"),h.push("display: block;"),h.push("}")),l&&(i.activeSiteList===o.blackList&&!c||i.activeSiteList===o.whiteList&&u)&&i.mode===t.dark&&(a&&i.invertListed||!s&&!i.invertListed&&!a)){var g=e.getFixesFor(r);if(h.push("\\n/* Leading rule */"),h.push(this.createLeadingRule(i)),h.push("\\n/* Contrary rule */"),h.push(this.createContraryRule(i,g)),(i.useFont||i.textStroke>0)&&(h.push("\\n/* Font */"),h.push("* "+this.createTextDeclaration(i))),h.push("\\n/* Text contrast */"),h.push("html {\\n  text-shadow: 0 0 0 !important;\\n}"),h.push("\\n/* Full screen */"),h.push("*:-webkit-full-screen, *:-webkit-full-screen * {\\n  -webkit-filter: none !important;\\n}"),!this.filterAppliesToHtml){var d=i.mode===t.dark?0:1,f=[[d=(d=d*i.brightness/100)*i.contrast/100-.5*i.contrast/100+.5],[d],[d],[1]],m=i.sepia/100,v=function(e,t){for(var n=[],o=0;o<e.length;o++){n[o]=[];for(var i=0;i<t[0].length;i++){for(var r=0,s=0;s<e[0].length;s++)r+=e[o][s]*t[s][i];n[o][i]=r}}return n}([[.393+.607*(1-m),.769-.769*(1-m),.189-.189*(1-m),0],[.349-.349*(1-m),.686+.314*(1-m),.168-.168*(1-m),0],[.272-.272*(1-m),.534-.534*(1-m),.131+.869*(1-m),0],[0,0,0,1]],f),S=v[0][0],y=v[1][0],b=v[2][0];S>1&&(S=1),S<0&&(S=0),y>1&&(y=1),y<0&&(y=0),b>1&&(b=1),b<0&&(b=0);var L={r:Math.round(255*S),g:Math.round(255*y),b:Math.round(255*b),toString:function(){return"rgb("+this.r+","+this.g+","+this.b+")"}};h.push("\\n/* Page background */"),h.push("html {\\n  background: "+L+" !important;\\n}")}g.rules&&i.mode===t.dark&&(h.push("\\n/* Custom rules */"),h.push(g.rules.join("\\n")))}return h.push(""),h.push("}"),h.join("\\n")},i.prototype.createLeadingRule=function(e){var n="html {\\n  -webkit-filter: ";return e.mode===t.dark&&(n+="invert(100%) hue-rotate(180deg) "),n+=100==e.brightness?"":"brightness("+e.brightness+"%) ",n+=100==e.contrast?"":"contrast("+e.contrast+"%) ",n+=0==e.grayscale?"":"grayscale("+e.grayscale+"%) ",n+="!important;\\n}"},i.prototype.createContraryRule=function(e,t){var n=[];if(t.invert.length>0){var o=t.invert.join(",\\n")+" {\\n  -webkit-filter: ";o+="invert(100%) hue-rotate(180deg) ",o+="!important;\\n}",n.push(o)}if(t.noinvert.length>0){var i=t.noinvert.join(",\\n")+" {\\n  -webkit-filter: ";i+="none ",i+="!important;\\n}",n.push(i)}if(t.removebg.length>0){var r=t.removebg.join(",\\n")+" {\\n  background: ";r+="white ",r+="!important;\\n}",n.push(r)}return n.join("\\n")},i.prototype.createTextDeclaration=function(e){var t="{\\n  ";return e.useFont&&(t+=e.fontFamily?"font-family: "+e.fontFamily+" !important; ":""),e.textStroke>0&&(t+=0==e.textStroke?"":"-webkit-text-stroke: "+e.textStroke+"px !important;"),t+="\\n}"},i}();e.FilterCssGenerator=i}(DarkReader),function(e){!function(t){t.popupWindow,window.chrome&&!chrome.extension&&window.browser&&window.browser.extension&&(chrome.extension=window.browser.extension),window.chrome&&chrome.extension?(chrome.runtime.sendMessage({action:"loadConfig"},(({DARK_SITES:n,INVERSION_FIXES:o})=>{e.DARK_SITES=n,e.INVERSION_FIXES=o,e.Background={},e.Background.extension=new e.Extension(new e.FilterCssGenerator,(()=>{t.popupWindow=new e.Popup.PopupWindow(e.Background.extension)}))})),window.addEventListener("unload",(function(e){t.popupWindow.scope=null,t.popupWindow.remove()}))):t.popupWindow=new t.PopupWindow(xp.observable({enabled:!0,config:{mode:1,brightness:110,contrast:80,grayscale:30,sepia:10,warm:20,useFont:!1,fontFamily:"Segoe UI",textStroke:0,siteList:["mail.google.com","npmjs.com"],blackList:["mail.google.com"],whiteList:["npmjs.com"],activeSiteList:1,modeSchedule:0,modeScheduleFrom:"",modeScheduleTo:"",nightSchedule:0,nightScheduleFrom:"",nightScheduleTo:"",invertListed:!1},fonts:["Arial","B","C","D","E","F","G","H","Open Sans","Segoe UI","T","U","V","W","X","Y","Z"],getActiveTabInfo:function(e){e({host:"server1.mail.veryverylongnameveryverylongnameveryverylongnameveryverylongname.com"})}}))}(e.Popup||(e.Popup={}))}(DarkReader||(DarkReader={}));